# Go 依赖注入方式对比与实践

本项目展示了三种不同的依赖注入方式，它们可以和平共存，你可以根据具体场景选择最适合的方式。

## 目录

- [概述](#概述)
- [方式一：手动依赖注入（Container）](#方式一手动依赖注入container)
- [方式二：Google Wire（编译时注入）](#方式二google-wire编译时注入)
- [方式三：Uber fx（运行时注入）](#方式三uber-fx运行时注入)
- [三种方式对比](#三种方式对比)
- [选型建议](#选型建议)
- [项目架构总览](#项目架构总览)

---

## 概述

| 模块 | 依赖注入方式 | 文件位置 |
|------|-------------|----------|
| User | 手动（Container） | `internal/handler/user/` |
| Product | 手动（Container） | `internal/handler/product/` |
| Order | Google Wire | `internal/handler/order/` |
| Payment | Uber fx | `internal/handler/payment/` |

---

## 方式一：手动依赖注入（Container）

### 简介

最简单直接的方式，通过一个集中的 Container 结构体管理所有依赖实例。

### 核心文件

```
internal/
├── app/
│   └── container.go      # 依赖容器
├── handler/user/
│   └── module.go         # 模块初始化
└── handler/product/
    └── module.go         # 模块初始化
```

### 实现代码

**1. 定义 Container（`internal/app/container.go`）**

```go
package app

type Container struct {
    DB *gorm.DB

    // Repositories
    UserRepo    repository.UserRepository
    ProductRepo repository.ProductRepository

    // Services
    UserService    interfaces.UserService
    ProductService interfaces.ProductService
}

// NewContainer 按依赖顺序初始化：DB → Repositories → Services
func NewContainer(db *gorm.DB) (*Container, error) {
    c := &Container{DB: db}

    // 初始化 Repositories
    c.UserRepo = repository.NewUserRepository(db)
    c.ProductRepo = repository.NewProductRepository(db)

    // 初始化 Services
    var err error
    c.UserService, err = userSrv.NewUserService(
        userSrv.WithUserRepository(c.UserRepo),
    )
    if err != nil {
        return nil, err
    }

    c.ProductService, err = productSrv.NewProductService(
        productSrv.WithProductRepository(c.ProductRepo),
    )
    if err != nil {
        return nil, err
    }

    return c, nil
}
```

**2. 模块初始化（`internal/handler/user/module.go`）**

```go
package user

type UserModule struct {
    handler *UserHandler
}

// Init 从 Container 获取依赖
func (m *UserModule) Init(container *app.Container) error {
    m.handler = NewUserHandler(container.UserService)
    return nil
}

func (m *UserModule) RegisterRoutes(router *gin.Engine) {
    m.handler.RegisterRoutes(router)
}
```

### 优点

- ✅ 代码简单直观，无学习成本
- ✅ 完全可控，易于调试
- ✅ 无外部依赖
- ✅ IDE 跳转友好

### 缺点

- ❌ 新增依赖需要修改 Container
- ❌ 依赖顺序需要手动管理
- ❌ 大型项目 Container 会变得臃肿

### 适用场景

- 小型项目
- 团队对 DI 框架不熟悉
- 依赖关系简单

---

## 方式二：Google Wire（编译时注入）

### 简介

Google 开发的编译时依赖注入工具，通过代码生成实现依赖注入，类型安全且无运行时开销。

### 安装

```bash
go install github.com/google/wire/cmd/wire@latest
go get github.com/google/wire
```

### 核心文件

```
internal/handler/order/
├── order.go       # Handler 实现
├── module.go      # 模块初始化
├── wire.go        # Wire 配置（Provider Set）
└── wire_gen.go    # Wire 生成的代码（自动生成）
```

### 实现代码

**1. 定义 Provider Set（`internal/handler/order/wire.go`）**

```go
//go:build wireinject
// +build wireinject

package order

import (
    "github.com/google/wire"
    "github.com/innovationmech/simple-cli/internal/repository"
    orderSrv "github.com/innovationmech/simple-cli/internal/service/order"
    "gorm.io/gorm"
)

// OrderProviderSet 定义依赖提供者集合
var OrderProviderSet = wire.NewSet(
    repository.NewOrderRepository,
    repository.NewProductRepository,
    orderSrv.NewOrderService,
    NewOrderHandler,
)

// InitializeOrderHandler 定义注入函数签名
// Wire 会根据 ProviderSet 自动生成实现
func InitializeOrderHandler(db *gorm.DB) (*OrderHandler, error) {
    wire.Build(OrderProviderSet)
    return nil, nil
}
```

**2. 生成代码**

```bash
cd internal/handler/order && wire
```

**3. 生成的代码（`wire_gen.go`）**

```go
// Code generated by Wire. DO NOT EDIT.

//go:build !wireinject

package order

func InitializeOrderHandler(db *gorm.DB) (*OrderHandler, error) {
    orderRepository := repository.NewOrderRepository(db)
    productRepository := repository.NewProductRepository(db)
    orderService := order.NewOrderService(orderRepository, productRepository)
    orderHandler := NewOrderHandler(orderService)
    return orderHandler, nil
}
```

**4. 模块初始化（`internal/handler/order/module.go`）**

```go
package order

type OrderModule struct {
    handler *OrderHandler
}

func (m *OrderModule) Init(container *app.Container) error {
    // 使用 Wire 生成的函数
    handler, err := InitializeOrderHandler(container.DB)
    if err != nil {
        return err
    }
    m.handler = handler
    return nil
}
```

### 优点

- ✅ 编译时类型检查，错误早发现
- ✅ 零运行时开销
- ✅ 生成的代码可读，便于调试
- ✅ 自动解析依赖顺序

### 缺点

- ❌ 需要额外的代码生成步骤
- ❌ 不支持运行时动态依赖
- ❌ 不支持生命周期管理

### 常用命令

```bash
# 生成代码
wire

# 检查依赖图
wire check

# 显示依赖图
wire show
```

### 适用场景

- 中大型项目
- 对性能有要求
- 需要编译时类型安全

---

## 方式三：Uber fx（运行时注入）

### 简介

Uber 开发的运行时依赖注入框架，基于反射实现，支持模块化和生命周期管理。

### 安装

```bash
go get go.uber.org/fx
```

### 核心文件

```
internal/handler/payment/
├── payment.go     # Handler 实现
├── module.go      # 模块初始化
└── fx.go          # fx Provider 定义
```

### 实现代码

**1. 定义 fx Module（`internal/handler/payment/fx.go`）**

```go
package payment

import (
    "github.com/innovationmech/simple-cli/internal/repository"
    paymentSrv "github.com/innovationmech/simple-cli/internal/service/payment"
    "go.uber.org/fx"
)

// FxModule 定义模块的所有依赖提供者
var FxModule = fx.Module("payment",
    // 提供 Repository
    fx.Provide(repository.NewPaymentRepository),
    fx.Provide(repository.NewOrderRepository),

    // 提供 Service
    fx.Provide(paymentSrv.NewPaymentService),

    // 提供 Handler
    fx.Provide(NewPaymentHandler),
)
```

**2. 模块初始化（`internal/handler/payment/module.go`）**

```go
package payment

import (
    "context"
    "go.uber.org/fx"
    "gorm.io/gorm"
)

type PaymentModule struct {
    handler *PaymentHandler
}

func (m *PaymentModule) Init(container *app.Container) error {
    var handler *PaymentHandler

    // 创建 fx App
    fxApp := fx.New(
        fx.NopLogger, // 禁用默认日志

        // 提供外部依赖
        fx.Provide(func() *gorm.DB {
            return container.DB
        }),

        // 加载模块
        FxModule,

        // 提取结果
        fx.Populate(&handler),
    )

    // 启动（触发依赖构建）
    if err := fxApp.Start(context.Background()); err != nil {
        return err
    }

    m.handler = handler
    return nil
}
```

### fx 高级特性

**生命周期管理**

```go
fx.Provide(func(lc fx.Lifecycle, db *gorm.DB) *Service {
    svc := NewService(db)
    
    lc.Append(fx.Hook{
        OnStart: func(ctx context.Context) error {
            return svc.Start()
        },
        OnStop: func(ctx context.Context) error {
            return svc.Stop()
        },
    })
    
    return svc
})
```

**命名依赖**

```go
// 提供命名依赖
fx.Provide(
    fx.Annotate(
        NewReadDB,
        fx.ResultTags(`name:"readDB"`),
    ),
    fx.Annotate(
        NewWriteDB,
        fx.ResultTags(`name:"writeDB"`),
    ),
)

// 注入命名依赖
fx.Provide(
    fx.Annotate(
        NewService,
        fx.ParamTags(`name:"readDB"`, `name:"writeDB"`),
    ),
)
```

**可选依赖**

```go
type Params struct {
    fx.In
    
    Logger *Logger `optional:"true"`
}
```

### 优点

- ✅ 支持生命周期管理（OnStart/OnStop）
- ✅ 支持模块化组织
- ✅ 支持命名依赖和可选依赖
- ✅ 无需代码生成

### 缺点

- ❌ 运行时反射有轻微性能开销
- ❌ 错误在运行时才能发现
- ❌ 调试相对困难
- ❌ 学习曲线较陡

### 适用场景

- 需要生命周期管理
- 依赖关系复杂
- 需要运行时动态配置

---

## 三种方式对比

| 特性 | 手动注入 | Google Wire | Uber fx |
|------|---------|-------------|---------|
| **实现方式** | 显式代码 | 代码生成 | 反射 |
| **注入时机** | 手动 | 编译时 | 运行时 |
| **类型安全** | ✅ | ✅ | ⚠️ 运行时检查 |
| **性能** | 最优 | 零开销 | 轻微开销 |
| **生命周期** | ❌ 手动管理 | ❌ | ✅ OnStart/OnStop |
| **依赖解析** | 手动 | 自动 | 自动 |
| **调试难度** | 简单 | 简单 | 中等 |
| **学习成本** | 无 | 低 | 中 |
| **外部依赖** | 无 | wire 工具 | fx 库 |
| **动态依赖** | ❌ | ❌ | ✅ |
| **模块化** | 手动 | ProviderSet | fx.Module |

### 性能对比

```
手动注入:  ~0ns   (直接调用)
Wire:      ~0ns   (编译时生成，等同手动)
fx:        ~1-5μs (反射开销，仅初始化时)
```

---

## 选型建议

### 选择手动注入

- 项目规模小（< 10 个服务）
- 依赖关系简单
- 团队对 DI 概念不熟悉
- 追求最大简洁性

### 选择 Google Wire

- 中大型项目
- 需要编译时类型检查
- 对启动性能有要求
- 依赖关系稳定

### 选择 Uber fx

- 需要生命周期管理（数据库连接池、消息队列等）
- 依赖关系复杂
- 需要运行时动态配置
- 微服务架构

### 混合使用

如本项目所示，三种方式可以和平共存：

```go
modules := []Module{
    &health.HealthModule{},
    &user.UserModule{},      // 手动注入
    &product.ProductModule{}, // 手动注入
    &order.OrderModule{},     // Wire
    &payment.PaymentModule{}, // fx
}
```

---

## 项目架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Server Layer                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    server.go                             │    │
│  │  modules := []Module{ ... }                              │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Module Layer                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  User    │ │ Product  │ │  Order   │ │ Payment  │           │
│  │ (Manual) │ │ (Manual) │ │ (Wire)   │ │ (fx)     │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Handler Layer                              │
│  UserHandler  ProductHandler  OrderHandler  PaymentHandler      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service Layer                              │
│  UserService  ProductService  OrderService  PaymentService      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Repository Layer                            │
│  UserRepo     ProductRepo     OrderRepo     PaymentRepo         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Database Layer                             │
│                          *gorm.DB                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 快速参考

### 添加新模块（手动注入）

1. 在 `Container` 中添加 Repository 和 Service
2. 创建 `handler/xxx/module.go`
3. 在 `server.go` 中注册模块

### 添加新模块（Wire）

1. 创建 `handler/xxx/wire.go`
2. 运行 `cd internal/handler/xxx && wire`
3. 创建 `handler/xxx/module.go`
4. 在 `server.go` 中注册模块

### 添加新模块（fx）

1. 创建 `handler/xxx/fx.go`
2. 创建 `handler/xxx/module.go`
3. 在 `server.go` 中注册模块

---

## 参考链接

- [Google Wire 官方文档](https://github.com/google/wire)
- [Uber fx 官方文档](https://github.com/uber-go/fx)
- [Wire 用户指南](https://github.com/google/wire/blob/main/docs/guide.md)
- [fx 入门指南](https://uber-go.github.io/fx/get-started/)

